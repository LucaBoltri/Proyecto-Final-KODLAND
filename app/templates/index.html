<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Acceso Video ▣ Subtitula & Resume</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

  <div class="stack">
    <header>
      <h1>Acceso Video ▣ Subtitula &amp; Resume</h1>
      <p>Elegí un video, enviá y te devolvemos subtítulos + resumen en texto, voz y varios idiomas.</p>
    </header>

    <!-- Formulario -->
    <form class="card" action="/upload" method="POST" enctype="multipart/form-data">
      <div class="field">
        <label for="file">Archivo de video</label>
        <input id="file" name="file" type="file" accept="video/*" required />
      </div>

      <div class="actions" style="flex-wrap:wrap">
        <!-- Idioma del audio -->
        <div class="field" style="min-width:220px">
          <label for="lang">Idioma del audio</label>
          {% set ul = used_language or 'auto' %}
          <select id="lang" name="lang">
            <option value="auto" {{ 'selected' if ul == 'auto' else '' }}>Detectar automáticamente</option>
            <option value="es"   {{ 'selected' if ul == 'es' else '' }}>Español</option>
            <option value="en"   {{ 'selected' if ul == 'en' else '' }}>Inglés</option>
            <option value="pt"   {{ 'selected' if ul == 'pt' else '' }}>Portugués</option>
            <option value="it"   {{ 'selected' if ul == 'it' else '' }}>Italiano</option>
            <option value="fr"   {{ 'selected' if ul == 'fr' else '' }}>Francés</option>
          </select>
        </div>

        <!-- Idioma del resumen -->
        <div class="field" style="min-width:220px">
          <label for="summary_lang">Idioma del resumen</label>
          {% set sl = summary_lang or 'orig' %}
          <select id="summary_lang" name="summary_lang">
            <option value="orig" {{ 'selected' if sl == 'orig' else '' }}>Mantener original</option>
            <option value="es"   {{ 'selected' if sl == 'es' else '' }}>Español</option>
            <option value="en"   {{ 'selected' if sl == 'en' else '' }}>Inglés</option>
            <option value="pt"   {{ 'selected' if sl == 'pt' else '' }}>Portugués</option>
            <option value="it"   {{ 'selected' if sl == 'it' else '' }}>Italiano</option>
            <option value="fr"   {{ 'selected' if sl == 'fr' else '' }}>Francés</option>
          </select>
        </div>

        <button type="submit">Enviar</button>
      </div>

      {% if message %}
        <p class="muted">OK: {{ message }}{% if file_id %} (id: {{ file_id }}){% endif %}</p>
      {% endif %}
    </form>

    <!-- Reproductor con subtítulos (múltiples pistas) -->
    {% if video_url %}
    <div class="card video-wrap">
      <video controls preload="metadata" muted playsinline>
        <source src="{{ video_url }}" />
        {% if tracks %}
          {% for t in tracks %}
            <track kind="subtitles" src="{{ t.url }}" srclang="{{ t.lang }}" label="{{ t.label }}" {% if t.default %}default{% endif %}>
          {% endfor %}
        {% endif %}
        Tu navegador no soporta la etiqueta de video.
      </video>
    </div>
    {% endif %}

    {% if preview or summary or srt_url or summary_audio_url or txt_url %}
    <section class="card">

      {% if preview %}
        <div class="section-title">Subtítulos (preview)</div>
        <div class="mono">
          {% for s in preview %}
          [{{ '%.1f'|format(s.start) }}–{{ '%.1f'|format(s.end) }}] {{ s.text }}<br>
          {% endfor %}
        </div>
      {% endif %}

      {% if summary %}
        <div class="section-title">Resumen</div>
        <p>{{ summary }}</p>

        {% if summary_audio_url %}
        <div class="field" style="margin-top:8px">
          <audio id="summaryAudio" controls preload="metadata" style="width:100%">
            <source src="{{ summary_audio_url }}" />
            Tu navegador no soporta el tag de audio.
          </audio>
          <button type="button" onclick="document.getElementById('summaryAudio').play()">▶️ Escuchar resumen</button>
        </div>
        {% endif %}

        {% if file_id %}
        <!-- Traducir RESUMEN (post-proceso) -->
        <form action="/translate" method="POST" class="field" style="margin-top:12px;gap:8px;display:flex;align-items:center">
          <input type="hidden" name="file_id" value="{{ file_id }}">
          <label for="target_lang" style="margin-right:6px">Traducir este resumen a:</label>
          <select id="target_lang" name="target_lang" required>
            <option value="" disabled selected>Elegí un idioma…</option>
            <option value="es">Español</option>
            <option value="en">Inglés</option>
            <option value="pt">Portugués</option>
            <option value="it">Italiano</option>
            <option value="fr">Francés</option>
          </select>
          <button type="submit">Traducir</button>
        </form>

        <!-- Generar UNA pista de subtítulos traducida -->
        {% set existing = existing_subs or [] %}
        <form action="/translate_subs" method="POST" class="field" style="margin-top:12px;gap:12px;display:flex;align-items:center;flex-wrap:wrap">
          <input type="hidden" name="file_id" value="{{ file_id }}">
          <span>Traducir subtítulos a:</span>

          <label>
            <input type="radio" name="subs_lang" value="en" {% if 'en' in existing %}disabled{% endif %}>
            English
            {% if 'en' in existing %}<small class="muted">(ya generado)</small>{% endif %}
          </label>

          <label>
            <input type="radio" name="subs_lang" value="pt" {% if 'pt' in existing %}disabled{% endif %}>
            Português
            {% if 'pt' in existing %}<small class="muted">(ya generado)</small>{% endif %}
          </label>

          <label>
            <input type="radio" name="subs_lang" value="it" {% if 'it' in existing %}disabled{% endif %}>
            Italiano
            {% if 'it' in existing %}<small class="muted">(ya generado)</small>{% endif %}
          </label>

          <label>
            <input type="radio" name="subs_lang" value="fr" {% if 'fr' in existing %}disabled{% endif %}>
            Français
            {% if 'fr' in existing %}<small class="muted">(ya generado)</small>{% endif %}
          </label>

          <button type="submit">Generar pista</button>
        </form>
        {% endif %}
      {% endif %}

      {% if srt_url or txt_url %}
        <div class="section-title">Descargas</div>
        <p class="download">
          {% if srt_url %}⬇️ <a href="{{ srt_url }}" download>Descargar SRT</a>{% endif %}
          {% if srt_url and txt_url %}&nbsp;|&nbsp;{% endif %}
          {% if txt_url %}⬇️ <a href="{{ txt_url }}" download>Descargar Resumen (.txt)</a>{% endif %}
        </p>
      {% endif %}
    </section>
    {% endif %}
  </div>

</body>
</html>
